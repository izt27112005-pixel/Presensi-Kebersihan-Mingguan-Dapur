<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Presensi Kebersihan Mingguan per Area</title>
<style>
:root{
  --bg:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  --panel:rgba(255,255,255,0.06);
  --ink:#e8ecf1; --muted:#9aa6b2;
  --brand:#00eaff; --brand2:#a97aff;
  --grid:rgba(255,255,255,0.12);
  --radius:12px;
  --shadow:0 18px 48px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);
     font:500 14px/1.55 "Inter",system-ui,Segoe UI,Roboto,Arial;min-height:100vh;}

header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 20px;background:rgba(0,0,0,0.50);
  box-shadow:var(--shadow);backdrop-filter:blur(8px);
  animation:slideDown .6s ease;
}
@keyframes slideDown{from{transform:translateY(-30px);opacity:0}
                     to{transform:translateY(0);opacity:1}}
h1{margin:0;font-size:18px;color:var(--brand);letter-spacing:.3px}

input,button,select{
  padding:10px 12px;border-radius:10px;border:1px solid #333;
  background:#151a22;color:var(--ink);transition:.25s;
}
button:hover{background:#1d2330;cursor:pointer;
  box-shadow:0 0 8px var(--brand2),0 0 14px var(--brand)}
select:hover, input:focus{outline:1px solid #3a4a78}

.toolbar{
  padding:10px 14px;background:rgba(0,0,0,.35);
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  backdrop-filter:blur(6px);animation:fadeIn .7s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.toolbar .chip{
  padding:6px 10px;border:1px solid var(--grid);border-radius:999px;
  background:rgba(255,255,255,.06);font-size:12px;color:#cfe6ff
}

.wrap{padding:12px}
table{
  border-collapse:collapse;width:100%;font-size:13px;background:var(--panel);
  border-radius:14px;overflow:hidden;box-shadow:var(--shadow)
}
th,td{
  border:1px solid var(--grid);padding:10px 8px;text-align:center;
  transition:.25s background-color,.25s color
}
thead th{background:rgba(255,255,255,.08);position:sticky;top:0}
tbody tr{animation:rowIn .45s ease both}
@keyframes rowIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
tbody tr:hover{background:rgba(255,255,255,.05)}
td[contenteditable="true"]{background:rgba(255,255,255,.04)}
td[contenteditable="true"]:focus{outline:2px solid var(--brand)}

.checkbox{
  appearance:none;width:18px;height:18px;border-radius:6px;
  border:1px solid #566; background:#0f141c;cursor:pointer;
  position:relative;transition:all .18s;overflow:hidden
}
.checkbox:checked{
  background:linear-gradient(180deg,var(--brand),var(--brand2));
  box-shadow:0 0 6px var(--brand2),0 0 12px rgba(169,122,255,.45);
  border-color:var(--brand2)
}
.checkbox:active{transform:scale(.95)}

.footer{
  padding:12px 14px;background:rgba(0,0,0,.35);
  font-size:12px;color:var(--muted);backdrop-filter:blur(6px)
}
.note{
  margin-top:8px;padding:10px;border:1px dashed #666;border-radius:10px;
  background:rgba(255,255,255,.03);transition:.25s
}
.note[contenteditable="true"]{outline:2px solid var(--brand)}

@media (max-width:700px){
  th,td{padding:8px 6px;font-size:12px}
}
</style>
</head>
<body>
<header>
  <h1>Presensi Kebersihan Mingguan per Area</h1>
  <div>
    <input type="password" id="adminPass" placeholder="Password Admin (q11)">
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<div class="toolbar">
  <select id="yearSelect" title="Pilih Tahun"></select>
  <select id="monthSelect" title="Pilih Bulan"></select>
  <!-- Tombol tambah/hapus HANYA untuk admin (disembunyikan default) -->
  <button id="addRow" style="display:none;">Tambah Baris</button>
  <button id="delRow" style="display:none;">Hapus Baris</button>
  <span class="chip">Mode: <strong id="modeInfo">View Only</strong></span>
  <span class="chip" id="syncBadge" style="display:none;">Sinkronisasi…</span>
</div>

<div class="wrap">
  <table id="grid" aria-label="Presensi Kebersihan Mingguan per Area">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="footer">
  <div>Catatan (per bulan & tahun):</div>
  <div class="note" id="note" contenteditable="false">
    Hanya admin yang dapat mengubah catatan ini.
  </div>
</div>

<!-- Firebase (CDN) + App logic -->
<script type="module">
/* ================= Firebase Setup (Realtime Database) ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* ====== GANTI CONFIG INI JIKA PERLU (dari Firebase Console milikmu) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCX-M-eNScPTqmtIOp7Zs1fFwkIg27VkF0",
  authDomain: "data-jamaah-dapur.firebaseapp.com",
  databaseURL: "https://data-jamaah-dapur-default-rtdb.firebaseio.com",
  projectId: "data-jamaah-dapur",
  storageBucket: "data-jamaah-dapur.firebasestorage.app",
  messagingSenderId: "963461575071",
  appId: "1:963461575071:web:af16848f8f54b99c178daa",
  measurementId: "G-5X4FTYVR5S"
};

const app = initializeApp(firebaseConfig);
try { getAnalytics(app); } catch(e) {/* analytics optional di local file */ }
const db = getDatabase(app);

/* ================= App State & DOM ================= */
const ADMIN_PASSWORD = "q11";                 // PIN admin
const PATH_ROOT = "presensi_kebersihan";      // path khusus app ini

const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const dom = {
  thead: document.getElementById('thead'),
  tbody: document.getElementById('tbody'),
  note: document.getElementById('note'),
  year: document.getElementById('yearSelect'),
  month: document.getElementById('monthSelect'),
  addRow: document.getElementById('addRow'),
  delRow: document.getElementById('delRow'),
  modeInfo: document.getElementById('modeInfo'),
  adminPass: document.getElementById('adminPass'),
  loginBtn: document.getElementById('loginBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  syncBadge: document.getElementById('syncBadge'),
};

let isAdmin = false;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let lastData = {};            // cache snapshot terkini untuk render cepat
let isSelfSaving = false;     // cegah loop render sendiri

/* ================= Utilities ================= */
const ymKey = (y,m) => `${y}-${m}`;
const getWeeksCount = (y,m) => Math.ceil(new Date(y,m+1,0).getDate()/7);
function showSync(on){ dom.syncBadge.style.display = on ? "inline-block" : "none"; }
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ================= Build UI ================= */
function buildHead(weeks){
  dom.thead.innerHTML = "";
  const tr = document.createElement('tr');
  tr.innerHTML = "<th>Nama Area</th><th>PJ Kebersihan</th>";
  for(let i=1;i<=weeks;i++){
    const th = document.createElement('th'); th.textContent = `Minggu ke-${i}`;
    tr.appendChild(th);
  }
  dom.thead.appendChild(tr);
}

function createRow(area="", pj="", checks=[], weekCount=4){
  const tr = document.createElement('tr');

  const tdArea = document.createElement('td');
  tdArea.textContent = area;
  tdArea.contentEditable = isAdmin;   // viewer tidak bisa edit
  tr.appendChild(tdArea);

  const tdPIC = document.createElement('td');
  tdPIC.textContent = pj;
  tdPIC.contentEditable = isAdmin;    // viewer tidak bisa edit
  tr.appendChild(tdPIC);

  for(let i=0;i<weekCount;i++){
    const td = document.createElement('td');
    const cb = document.createElement('input');
    cb.type = "checkbox";
    cb.className = "checkbox";
    cb.checked = !!checks[i];
    cb.disabled = !isAdmin;           // viewer checkbox terkunci
    cb.addEventListener('change', onAnyEdit);
    td.appendChild(cb);
    tr.appendChild(td);
  }

  tdArea.addEventListener('input', debouncedAnyEdit);
  tdPIC.addEventListener('input', debouncedAnyEdit);

  return tr;
}

function applyMode(){
  dom.modeInfo.textContent = isAdmin ? "Admin" : "View Only";
  dom.note.contentEditable = isAdmin ? "true" : "false";
  dom.addRow.style.display = isAdmin ? "inline-block" : "none";
  dom.delRow.style.display = isAdmin ? "inline-block" : "none";

  // toggle editability untuk baris yang sudah ada
  [...dom.tbody.querySelectorAll('tr')].forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    tds[0].contentEditable = isAdmin;
    tds[1].contentEditable = isAdmin;
    tr.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.disabled = !isAdmin);
  });
}

/* ================= Data <-> UI ================= */
function renderFromData(store){
  lastData = store || {};
  const y = currentYear, m = currentMonth;
  const weeks = getWeeksCount(y,m);
  buildHead(weeks);
  dom.tbody.innerHTML = "";

  const areas = lastData.areas && Array.isArray(lastData.areas) && lastData.areas.length
    ? lastData.areas
    : [{area:"Lobby", pj:"Budi"},{area:"Toilet", pj:"Siti"}];

  const key = ymKey(y,m);
  const checksForYM = (lastData.checklists && lastData.checklists[key]) || [];

  for(let i=0;i<areas.length;i++){
    const rowChecks = Array.from({length:weeks}, (_,w)=> (checksForYM[i] && checksForYM[i][w])===true);
    dom.tbody.appendChild( createRow(areas[i].area, areas[i].pj, rowChecks, weeks) );
  }

  dom.note.textContent = (lastData.notes && lastData.notes[key]) || "Hanya admin yang dapat mengubah catatan ini.";
  applyMode();
}

function collectCurrentUI(){
  const rows = [...dom.tbody.querySelectorAll('tr')];
  const areas = rows.map(tr=>{
    const tds = tr.querySelectorAll('td');
    return { area: tds[0].textContent.trim(), pj: tds[1].textContent.trim() };
  });
  const checks = rows.map(tr=>{
    return [...tr.querySelectorAll('input[type="checkbox"]')].map(cb=>cb.checked);
  });
  return { areas, checks, note: dom.note.textContent };
}

/* ================= Firebase Realtime ================= */
const rootRef = ref(db, PATH_ROOT);
onValue(rootRef, (snap)=>{
  if(isSelfSaving){ // kita yang barusan menulis — abaikan satu siklus render
    isSelfSaving = false;
    showSync(false);
    return;
  }
  const data = snap.exists() ? snap.val() : {};
  renderFromData(data);
});

/* ================= AUTOSAVE (Admin only) ================= */
function makeUpdatesForCurrent(data){
  const key = ymKey(currentYear, currentMonth);
  const updates = {};
  updates[`${PATH_ROOT}/areas`] = data.areas;                  // global
  updates[`${PATH_ROOT}/checklists/${key}`] = data.checks;     // per bulan-tahun
  updates[`${PATH_ROOT}/notes/${key}`] = data.note;            // per bulan-tahun
  return updates;
}

function saveNow(){
  if(!isAdmin) return;
  const payload = collectCurrentUI();
  const updates = makeUpdatesForCurrent(payload);
  isSelfSaving = true;
  showSync(true);
  update(ref(db), updates).catch(err=>{
    isSelfSaving = false;
    showSync(false);
    alert("Gagal menyimpan: "+(err?.message||err));
  });
}

const debouncedAnyEdit = debounce(saveNow, 300);
function onAnyEdit(){ saveNow(); }

/* ================= UI Events ================= */
// Tambah/Hapus baris — guard extra (kalau ada yang invoke via devtools)
dom.addRow.addEventListener('click', ()=>{
  if(!isAdmin) return;
  const weeks = dom.thead.querySelectorAll('th').length - 2;
  dom.tbody.appendChild( createRow("", "", [], weeks) );
  saveNow();
});
dom.delRow.addEventListener('click', ()=>{
  if(!isAdmin) return;
  const last = dom.tbody.lastElementChild;
  if(last){ last.remove(); saveNow(); }
});

// Catatan autosave
dom.note.addEventListener('input', debouncedAnyEdit);

// Ganti tahun/bulan: viewer boleh; admin autosave dulu lalu render
dom.year.addEventListener('change', ()=>{
  if(isAdmin) saveNow();
  currentYear = parseInt(dom.year.value,10);
  renderFromData(lastData); // render cepat dari cache; realtime onValue tetap jalan
});
dom.month.addEventListener('change', ()=>{
  if(isAdmin) saveNow();
  currentMonth = parseInt(dom.month.value,10);
  renderFromData(lastData);
});

/* ================= Auth (Admin PIN) ================= */
dom.loginBtn.addEventListener('click', ()=>{
  const pass = dom.adminPass.value.trim();
  if(pass === ADMIN_PASSWORD){
    isAdmin = true;
    applyMode();
    dom.loginBtn.style.display="none";
    dom.logoutBtn.style.display="inline-block";
    dom.adminPass.style.display="none";
    saveNow(); // sinkron awal
    alert("Login Admin sukses");
  }else{
    alert("Password salah");
  }
});
dom.logoutBtn.addEventListener('click', ()=>{
  saveNow(); // autosave ketika logout
  isAdmin = false;
  applyMode();
  dom.loginBtn.style.display="inline-block";
  dom.logoutBtn.style.display="none";
  dom.adminPass.style.display="inline-block";
  dom.adminPass.value="";
});

/* ================= Init selectors & first paint ================= */
(function initSelectors(){
  const nowY = new Date().getFullYear();
  for(let y=nowY-5; y<=nowY+7; y++){
    const o = document.createElement('option');
    o.value = y; o.textContent = y;
    dom.year.appendChild(o);
  }
  dom.year.value = currentYear;

  months.forEach((m,i)=>{
    const o = document.createElement('option');
    o.value = i; o.textContent = m;
    dom.month.appendChild(o);
  });
  dom.month.value = currentMonth;

  // Tampilkan struktur awal agar tidak kosong sebelum data realtime datang
  buildHead(getWeeksCount(currentYear, currentMonth));
  // Jika database masih kosong, tulis struktur minimal 1x (hanya saat admin login pertama kali akan menyimpan).
})();
</script>

</body>
    </html>
